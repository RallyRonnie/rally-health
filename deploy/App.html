<!DOCTYPE html>
<html>
<head>
    <title>Health Check</title>
    <!--  (c) 2013 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Fri Sep 06 2013 15:52:06 GMT-0700 (PDT) -->
    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/*
 */
Ext.define('Rally.technicalservices.logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var output_args = [];
        if (arguments.length === 0 ) {
            window.console && console.log(arguments);
            return;
        }
        if (arguments.length === 1 ) {
            output_args = arguments;
        } else {
            var src_class = arguments[0];
            var class_name = "";
            if ( typeof(src_class) === "string" ) {
                class_name = src_class;
            } else if ( typeof src_class.getName === "function") { 
                class_name = src_class.getName();
            } else if (typeof src_class.self.getName === 'function'){
                class_name = src_class.self.getName();
            }
            //window.console && console.log(class_name,"--",message);
            output_args = Ext.Array.push(output_args,[class_name,"--"]);
            output_args = Ext.Array.push(output_args,Ext.Array.slice(arguments,1));
        }
        window.console && console.log.apply(console,output_args);
    }

});
Ext.define('TSRenderers', {
    singleton: true,
    red: '#ff9999',
    yellow: '#ffffcc',
    green: '#ccffcc',
    defaultF: function(value,metaData,record,rowIndex,colIndex,store,view){
        return value;
    },
    estimateHealth: function(value) {
        if ( value < 0 ) {
            return " ";
        }
        var percent = parseInt( 100 * value, 10 );
        var color = TSRenderers.green;
        if ( percent < 91 ) {
            color = TSRenderers.yellow;
        }
        if ( percent < 61 ) {
            color = TSRenderers.red;
        }
        return "<div style='text-align:center;background-color:" + color + "'>"+ percent + "%</div>";
    }
    
});
Ext.define('Rally.technicalservices.util.Utilities', {
    singleton: true,
    hashToArray: function(hash) {
        var result = [];
        for ( var key in hash ) {
            result.push(hash[key]);
        }
        return result;
    },
    /*
     * Given a hash of TS projects where the key is the object id of the project,
     * return an array of TS projects with their parent/child relationships wired up
     */
    structureProjects: function(structured_projects, add_root) {
        var me = this;
        var potential_root = Ext.create('Rally.technicalservices.ProjectModel',{
            Name: 'Workspace',
            ObjectID: null
        });
        
        for ( var pid in structured_projects ) {
            var child = structured_projects[pid];
            if ( child.get('parent_id') && structured_projects[child.get('parent_id')] ) {
                var parent = structured_projects[child.get('parent_id')];
                parent.addChild(child);
            } else if ( add_root ) {
                potential_root.addChild(child);
            }
        }
        
        var results = this.hashToArray(structured_projects);
        if ( add_root ) {
            results.unshift(potential_root);
        }
        return results
    },
    /*
     * Given a hash that represents an item with children, return
     * an array of the items with the items exploded (in order, top down (follow a branch then come back to next branch))
     * 
     * That is, order is parent 1, child 1a, child 1b, parent 2, child 2a
     */
    hashToOrderedArray: function(hash,child_field_name) {
        var me = this;
        var the_array = [hash];
        
        var kids = hash[child_field_name];
// add this back if we want the order to be parent 1, parent 2, child 1a, child 1b, child 2a
//        Ext.Array.each(kids, function(kid){
//            the_array.push(kid);
//        });
        
        Ext.Array.each(kids, function(kid){
            var kid_array = me.hashToOrderedArray(kid,child_field_name);
            the_array = Ext.Array.merge(the_array,kid_array);
        });
        
        return the_array;
    },
    /**
     * Given a hash with nested hashes of similar strucure (nested by field "children"), 
     * find the item in the hash 
     *   where the given field has the given value
     */
    getFromHashByField: function(hash,by_field_name,by_field_value){
        var me = this;
        var result = null;
        if (hash[by_field_name] == by_field_value) {
            return hash;
        }
        if ( hash.children ) {
            Ext.Array.each(hash.children,function(child){
                result = me.getFromHashByField(child,by_field_name,by_field_value);
                if (result) {
                    return false;
                }
            });
        }
        return result;
    },
    /** 
     * Given an array ot TSProjects, get one out of the array by its ID
     */
    getProjectById: function(project_array,object_id) {
        var result = null;
        var field_name = "ObjectID";
        Ext.Array.each(project_array, function(project) {
            if (project.get(field_name) == object_id) {
                result = project;
            }
        });
        return result;
    }
});
var useName = function(value,record) {
    if ( record.get('Name') ) {
        return record.get('Name');
    } 
    return null;
}

var useObjectID = function(value,record) {
    if ( record.get('ObjectID') ) {
        return record.get('ObjectID');
    } 
    return 0;
}

Ext.define('Rally.technicalservices.ProjectModel',{
    extend: 'Ext.data.Model',
    fields: [
        {name:'ObjectID', type: 'int'},
        {name:'Name',type:'string'},
        {name:'parent_id',type:'int'},
        {name:'id',type:'int',convert:useObjectID},
        {name:'text',type:'string',convert:useName},
        /*  following values are calculated */
        {name:'child_count',type:'int',defaultValue:0},
        {name:'health_ratio_estimated',type:'float',defaultValue:0}
    ],
    hasMany:[{model:'Rally.technicalservices.ProjectModel', name:'children'}],
    associations: [
        {type:'belongsTo',model:'Rally.technicalservices.ProjectModel', setterName: 'setParent', getterName:'getParent', primaryKey:'ObjectID',foreignKey:'parent_id'}
    ],
    addChild: function(child) {
        this.set('health_ratio_estimated',-1);
        
        if ( child.get('parent_id') !== this.get('ObjectID') ) {
            child.setParent(this.get('ObjectID'));
        }
        if ( this.get('children') ) {
            var kids = this.get('children');
            kids.push(child);
            this.set('children',kids);
        } else {
            this.set('children',[child]);
        }
        this.set('child_count',this.get('children').length);
    },
    /**
     * override because we just want the kids without going through a load process
     */
    getAssociatedData: function(){
        var children = [];
        var kids = this.get('children');
        Ext.Array.each( kids, function(kid) {
            children.push(kid.getData(true));
        });
        return { 'children': children };
    },
    /**
     * Given an array of artifacts (stories and defects), calculate some health metrics
     * 
     */
    setIterationArtifacts: function(artifacts){
        // parents don't roll up.  set to -1
        if ( this.get('child_count')  > 0 ) {
            this.set('health_ratio_estimated',-1);
        } else {
            var plan_estimate_total = 0;
            var count_of_estimated_artifacts = 0;
            
            Ext.Array.each(artifacts,function(artifact){
                var plan_estimate = artifact.get('PlanEstimate') || 0;
                plan_estimate_total += plan_estimate;
                if ( plan_estimate > 0 ) {
                    count_of_estimated_artifacts++;
                }
            });
            
            if ( artifacts.length > 0 ) {
                this.set('health_ratio_estimated',(count_of_estimated_artifacts/artifacts.length));
            }
        }
    },
    resetHealth: function() {
        if ( this.get('children') && this.get('children').length > 0 ) {
            this.set('health_ratio_estimated',-1);
        } else {
            this.set('health_ratio_estimated',0);
        }
    }
});
/*
 * A store that holds projects
 * (DOES NOT update project information, must be passed projects)
 */
Ext.define('Rally.technicalservices.ProjectStore',{
    extend: 'Rally.data.custom.Store',
    alias: 'store.projectree',
    model: 'Rally.technicalservices.ProjectModel',
    
    getRecords: function() {
        var items = [];
        this.each(function(storeItem) {
            items.push(storeItem);
        });
        return items;
    },
    
    getModelType: function() {
        return this.model.getName();
    }
});
Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    logger: new Rally.technicalservices.logger(),
    items: [ { xtype:'container',itemId:'selector_box', padding: 5, layout: { type:'hbox'} }, { xtype:'container', itemId:'grid_box', padding: 5 } ],
    _selected_timebox: null,
    _project_store: null,
    launch: function() {
        this._getProjects();
        this._addIterationSelector();
    },
    _getProjects: function() {
        var me = this;
        this._projects = [];
        var selected_project_oid = this.getContext().getProject().ObjectID;
        
        Ext.create('Rally.data.WsapiDataStore',{
            model:'Project',
            autoLoad: true,
            listeners: {
                load: function(store,projects) {
                    var ts_project_hash = this._makeTSProjectHash(projects);
                    var ts_project_array = Rally.technicalservices.util.Utilities.structureProjects(ts_project_hash,true);
                    var ts_selected_project = Rally.technicalservices.util.Utilities.getProjectById(ts_project_array,selected_project_oid);
                    var ts_selected_projects = Rally.technicalservices.util.Utilities.hashToOrderedArray(ts_selected_project.getData(true),"children");

                    this._project_store = Ext.create('Rally.technicalservices.ProjectStore',{
                        data: ts_selected_projects
                    });
                    
                    this._project_store.load(function() { me._processData(); } );
                },
                scope: this
            }
        });
        
    },
    _addIterationSelector: function() {
        this.iteration_selector = this.down("#selector_box").add({
            xtype:'rallyiterationcombobox',
            listeners: {
                ready: function(cb){
                    this.logger.log(this,"ready");
                    this._updateIterationDisplay(cb);
                },
                change: function(cb,new_value,old_value){
                    this.logger.log(this,"change");
                    this._updateIterationDisplay(cb);
                },
                scope: this
            }
        });
        this.down('#selector_box').add({
            xtype:'container',
            itemId: 'iteration_range_box',
            tpl: [
                "{start_date} - {end_date}",
                '<tpl if="day_counter &gt; -1">',
                "<br/>This is day {day_counter} of the iteration",
                '</tpl>'
            ]
        });
    },
    _updateIterationDisplay: function(combobox) {
        this._selected_timebox = combobox.getRecord();
        var start_date = this._selected_timebox.get(combobox.getStartDateField());
        var end_date = this._selected_timebox.get(combobox.getEndDateField());
        var day_counter = -1;
        var today = new Date();
        if ( today >= start_date && today <= end_date ) {
            day_counter = Rally.util.DateTime.getDifference(today,start_date,"day");
        }
        var formatted_start_date = Rally.util.DateTime.formatWithNoYearWithDefault(start_date);
        var formatted_end_date = Rally.util.DateTime.formatWithNoYearWithDefault(end_date);
        
        this.down('#iteration_range_box').update({
            start_date:formatted_start_date,
            end_date:formatted_end_date,
            day_counter:day_counter
        });
        
        this._processData();
    },
    _processData:function() {
        var me = this;
        if ( me._project_store && me._selected_timebox) {
            me._return_counter = 0; // the calls for iterations are asynchronous, so we need to count returns
            var projects = me._project_store.getRecords();
            
            me.logger.log(this,"Sending requests for " + projects.length + " projects");
            Ext.Array.each(projects,function(project){
                project.resetHealth();
                me._calculateIterationData(me._selected_timebox.get('Name'),project);
            });

            this._makeGrid(this._project_store);
        }
    },
    /*
     * Given the name of an iteration and a TSProject, go get the iteration stories and defects
     * associated with an iteration with that name, then let the TSProject calculate various metrics
     */
    _calculateIterationData: function(iteration_name,project) {
        this.logger.log(this,"_calculateIterationData",iteration_name,project);
        var me = this;
        
        var artifacts = []; // have to get both stories and defects
        var filters = [
            {property:'Iteration.Name',value:iteration_name},
            {property:'Project.ObjectID',value:project.get('ObjectID')}
        ];
        
        var fetch = ['ObjectID','PlanEstimate','ScheduleState'];
        
        Ext.create('Rally.data.WsapiDataStore',{
            model: 'UserStory',
            autoLoad: true,
            filters: filters,
            fetch: fetch,
            listeners: {
                load: function(store,records){
                    artifacts = records;
                    Ext.create('Rally.data.WsapiDataStore',{
                        model:'Defect',
                        autoLoad: true,
                        filters: filters,
                        fetch: fetch,
                        listeners: {
                            load: function(store,records){
                                artifacts = Ext.Array.push(artifacts,records);
                                me.logger.log(this,project.get('Name'),artifacts.length);
                                project.setIterationArtifacts(artifacts);
                            }
                        }
                    });
                }
            }
        });
        
    },
    // given a set of Rally project objects, turn them into TS projects
    // the key of the hash is the project's ObjectID
    _makeTSProjectHash: function(projects) {
        var structured_projects = {}; // key is oid
        
        // change into our version of the project model
        // and put into a hash so we can find them easily for adding children
        Ext.Array.each(projects,function(project){
            var parent = project.get('Parent');
            var parent_oid = null;
            
            if ( parent ) { 
                parent_oid = parent.ObjectID; 
            }
            structured_projects[project.get('ObjectID')] = Ext.create('Rally.technicalservices.ProjectModel',{
                ObjectID: project.get('ObjectID'),
                parent_id: parent_oid,
                Name: project.get('Name')
            });
        });
        return structured_projects;
    },
    /*
     * Given an array of projects, make a grid
     */
    _makeGrid: function(store) {
        
        if ( this.grid ) { this.grid.destroy(); }
        
        this.grid = Ext.create('Rally.ui.grid.Grid',{
            store: store,
            height: 400,
            columnCfgs: [
                {text:'Project',dataIndex:'Name',flex: 1},
                {text:'Estimation Ratio',dataIndex:'health_ratio_estimated',renderer: TSRenderers.estimateHealth}
            ]
        });
        this.down('#grid_box').add(this.grid);
    }
});
            
               Rally.launchApp('CustomApp', {
                   name: 'Health Check'
               });
        });
    </script>
    
    
<link rel="stylesheet" type="text/css" href="src/style/app.css">

</head>
<body></body>
</html>